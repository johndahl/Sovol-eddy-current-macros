[gcode_macro CLEAN_NOZZLE] 
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
       G28
    {% endif %}
    G90
    G1 X240 Y325 F9000
    {% set noz_temp = params.NOZZLE|default(printer.extruder.target)|float %}
    {% set idle_temp = params.IDLE|default(printer.extruder.target)|float %}
    {% if noz_temp < 150 %}
        {% set noz_temp = 200 %}
    {% endif %}
    RESPOND TYPE=echo MSG="Clean debug {idle_temp}"
    {% if idle_temp < 150 %}
        {% set idle_temp = 150 %}
    {% endif %}

    # M117 Cleaning @ {{ noz_temp }}C
    RESPOND TYPE=echo MSG="Cleaning @ {noz_temp}"
    M109 S{noz_temp} 
    
    RUN_PROBE_VIR_CONTACT
    G91
    G1 Z10 F300
    G90
    
    # M104 S130
    M117 Clean nozzle

    G1 X240 Y360 F9000
    G90
    G1 Z-1.5 F300
    G1 X245 F4800
    G1 Y358 X271
    G1 x245
    G1 Y358 X271
    G1 X255
    G1 Y360 X271
    G1 X255
    G1 Y360 X271
    G1 X245
    G1 Y362 X271
    G1 X245
    G1 Y362 X271
    G1 X255

    M106 S255 # Full nozzle fan 
    
    G1 Y363 X271
    G1 X255
    G1 Y362 X271

    G1 Z100 F1000
    # Nozzle cleaning using the steel mesh
    #G91 
    #G1 z5 F400 
    #G90 
    #G1 x310 Y359 f4000 
    #G91 
    #G1 z-5 f400 
    #G90 
    #G1 X313 F4800 
    #G1 X310 
    #G1 X313 
    #G1 X310 
    #G1 X313 
    #G1 X310 
    #G91
    
    M104 S{idle_temp}
    M400
    M117 Clean Finish
    M109 S{idle_temp}
    M107 
    G91
    G1 Z10 F1000
    G90
    G28 Z0

[gcode_macro START_PRINT]
gcode:
    {% if printer.save_variables.variables.was_interrupted|float == True %}
        PRINT_END #Clear the last printed power-off information
        CHANG_ROOT_MAIN
        SET_DISPLAY_TEXT
    {% endif %}
    {% set bed_temp = params.BED|default(printer.heater_bed.target)|float %}
    {% set nozzle_temp = params.NOZZLE|default(printer.extruder.target)|float %}
    {% set clean_temp = params.CLEAN|default(printer.extruder.target)|float %}
    {% set idle_temp = params.IDLE|default(printer.extruder.target)|float %}

    M140 S{bed_temp} # Start heating the bed and continue
    G28 # Home all axis
    M190 S{bed_temp} # Wait until the bed has reached target temp
    M117 Soaking bed...
    RESPOND TYPE=echo MSG="START_PRINT: Soaking bed for 60s"
    G4 P60000                     ; 60,000 ms = 60 s
    RESPOND TYPE=echo MSG="START_PRINT: Soak done"
    M117 QGL
    QUAD_GANTRY_LEVEL # Level gantry
    
    CLEAR_PAUSE
    M117 Clean Nozzle
    CLEAN_NOZZLE NOZZLE={clean_temp} IDLE={idle_temp}
    
    M117 Eddy Calibration
    Z_OFFSET_CALIBRATION METHOD=force_overlay BED_TEMP={bed_temp} EXTRUDER_TEMP={idle_temp}
    SET_GCODE_VARIABLE MACRO=_global_var VARIABLE=has_z_offset_calibrated VALUE=True
    G28 Z
    M117 Mesh Calibration
    BED_MESH_CALIBRATE
    SET_GCODE_VARIABLE MACRO=_global_var VARIABLE=has_z_offset_calibrated VALUE=False

     # Load saved live z offset
    {% set stored_live_z = printer.save_variables.variables.live_z_offset|default(0.0)|float %}
    # Adjust nozzle height
    SET_GCODE_OFFSET Z={stored_live_z} MOVE=0
    
    RESPOND TYPE=echo MSG="Heating nozzle @ {nozzle_temp}"
    M104 S{nozzle_temp}   # set nozzle target
    M109 S{nozzle_temp}   # wait until nozzle target
    #save_last_file
   # M117 {last_file}

[gcode_macro END_PRINT]
description: 
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    M117 Finish Print!!!
    {% if printer.toolhead.homed_axes|lower == "xyz" %}
        G91
        {% if printer['filament_switch_sensor filament_sensor'].enable == True and
            printer['filament_switch_sensor filament_sensor'].filament_detected == True
        %}
            {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target and 
                printer.extruder.temperature >= e_mintemp)
            %}
                G1 E-2 F2700
                G1 E-2 Z0.2 F2400
            {% endif %}
        {% endif %}
        {% if (printer.gcode_move.position.z + 10) < z_max %}
            G1 Z+10 F3000
        {% else %}
            G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
                    {% endif %}
        G90
        G1 X0 Y350 F9000
    {% endif %}
    _ALL_FAN_OFF
    TURN_OFF_HEATERS 
    M220 S100
    M221 S100
    CLEAR_PAUSE
    PRINT_END
    M84 X Y Z E 
    {action_respond_info("Finish Print!")}

[gcode_macro SAVE_LIVE_Z]
#description: Save current live Z-offset as the new baseline
#gcode:
#    {% set pos_z  = printer.gcode_move.position.z|float %}
#    {% set gpos_z = printer.gcode_move.gcode_position.z|float %}
#    {% set live_z = gpos_z - pos_z %}
    #SAVE_VARIABLE VARIABLE=live_z_offset VALUE={live_z}
    #SAVE_VARIABLE VARIABLE=live_z_offset VALUE=-0.8
#    RESPOND TYPE=echo MSG="Saved live Z offset: {live_z}"
#    SAVE_VARIABLE VARIABLE=live_z_offset VALUE="{{ live_z }}"
    #RESPOND TYPE=echo MSG="Saved live Z offset: {{ live_z }} (pos_z={{ pos_z }}, gpos_z={{ gpos_z }})"
#    [gcode_macro SAVE_LIVE_Z]
description: Save current live Z-offset as the new baseline
gcode:
    SAVE_VARIABLE VARIABLE=live_z_offset VALUE={printer.gcode_move.position.z - printer.gcode_move.gcode_position.z}
    RESPOND TYPE=echo MSG="Saved live Z offset: {printer.gcode_move.position.z - printer.gcode_move.gcode_position.z}"

[gcode_macro PURGE_LINE]
description: Purge / wipe line with optional BED / NOZZLE temps
gcode:
    # ─── Temperature handling ───────────────────────────────
    # If BED / NOZZLE are passed → use them
    # otherwise use current heater targets.
    {% set bed_temp    = params.BED|default(printer.heater_bed.target)|float %}
    {% set nozzle_temp = params.NOZZLE|default(printer.extruder.target)|float %}

    # Optionally heat/verify temps if they are > 0
    {% if bed_temp > 0 %}
        M140 S{bed_temp}                         ; set bed temp (no wait)
    {% endif %}
    {% if nozzle_temp > 0 %}
        M104 S{nozzle_temp}                      ; set nozzle temp (no wait)
    {% endif %}

    {% if bed_temp > 0 %}
        M190 S{bed_temp}                         ; wait for bed
    {% endif %}
    {% if nozzle_temp > 0 %}
        M109 S{nozzle_temp}                      ; wait for nozzle
    {% endif %}

    # ─── Positioning & relative mode ────────────────────────
    G90
    G1 X0 Y20 F9000
    G1 Z0.600 F600
    G1 Y0 F9000
    M400
    G91
    M83

    # ─── Prime ───────────────────────────
    G1 E25 F300
    G4 P1000
    G1 E-0.200 Z5 F600

    # ─── Purge pattern ─────────────────
    G1 X88.000 F9000
    G1 Z-5.000 F600
    G1 X87.000 E20.88 F1800
    G1 X87.000 E13.92 F1800

    G1 Y1 E0.16 F1800
    G1 X-87.000 E13.92 F1800
    G1 X-87.000 E20.88 F1800

    G1 Y1 E0.24 F1800
    G1 X87.000 E20.88 F1800
    G1 X87.000 E13.92 F1800

    G1 E-0.200 Z1 F600
    M400
